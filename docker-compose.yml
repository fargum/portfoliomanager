version: '3.8'

services:
  # PostgreSQL Database Service
  # (Uncomment and configure if you want to run the database in this compose stack)
  # postgres:
  #   image: postgres:15
  #   container_name: portfoliomanager-db
  #   environment:
  #     POSTGRES_DB: portfoliomanager
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: your_password_here
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - portfoliomanager-network
  #   restart: unless-stopped

  # Portfolio Manager API Service
  portfoliomanager-api:
    build: 
      context: ./services/api
      dockerfile: Dockerfile
    image: portfoliomanager-api:latest
    container_name: portfoliomanager-api
    environment:
      # ASP.NET Core Configuration
      - ASPNETCORE_ENVIRONMENT=Development  # Enable Swagger
      - ASPNETCORE_URLS=http://+:8080
      - ASPNETCORE_HTTP_PORTS=8080
      
      # Database Connection (connects to your existing PostgreSQL container)
      # Uses environment variables from .env file
      - ConnectionStrings__DefaultConnection=Host=${DB_HOST:-host.docker.internal};Port=${DB_PORT:-5432};Database=${DB_NAME:-portfoliomanager};Username=${DB_USERNAME};Password=${DB_PASSWORD};Include Error Detail=true
      
      # EOD Historical Data API Configuration
      - EodApi__Token=${EOD_API_TOKEN}
      
      # Logging Configuration
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
      - Logging__LogLevel__Microsoft.EntityFrameworkCore=Information
      
      # Optional: Additional settings
      - AllowedHosts=*
    ports:
      - "8080:8080"
    networks:
      - portfoliomanager-network
    restart: unless-stopped
    # Removed depends_on since we're using external database
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Portfolio Manager UI Service
  portfoliomanager-ui:
    build: 
      context: ./services/ui
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_BASE_URL: http://localhost:8080
    image: portfoliomanager-ui:latest
    container_name: portfoliomanager-ui
    environment:
      - API_BASE_URL=http://portfoliomanager-api:8080
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:8080
    ports:
      - "3000:3000"
    networks:
      - portfoliomanager-network
    depends_on:
      - portfoliomanager-api
    restart: unless-stopped

networks:
  portfoliomanager-network:
    driver: bridge
    name: portfoliomanager-network

# Uncomment if running database in this stack
# volumes:
#   postgres_data: